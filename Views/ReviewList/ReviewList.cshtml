@model QAD_User_Review.ViewModels.ReviewListMainViewModel

@{
    ViewData["Title"] = "Review List";
}

<div class="card">
    <div class="card-header bg-success text-uppercase text-white text-center card-header-slim">
        <h6>QAD Review Process</h6>
    </div>

    @using (Html.BeginForm("Save", "ReviewList", FormMethod.Post))
    {
        <div class="flex-parent-element panel-border-bottom">

            <!-- Filter Panel -->
            <div class="flex-child-element panel-filter">
                <p class="mb-2"><strong>Approver:</strong> @Model.ReviewerName</p>

                <div class="mb-2">
                    <label for="filterPlant" class="small-label">Select by Plant:</label>
                    @{
                        var sortedPlants = Model.Plants.OrderBy(x => x.Text);
                    }
                    @Html.DropDownListFor(m => m.SelectedPlant,
                        new SelectList(sortedPlants, "Value", "Text"),
                        "-- All Plants --",
                        new { id = "filterPlant", @class = "form-control", onchange = "filterEmployees(); filterTable()" })
                </div>

                <div class="mb-2">
                    <label for="filterEmployee" class="small-label">Select by Employee:</label>
                    <select id="filterEmployee" class="form-control" onchange="filterTable()">
                        <option value="">-- All Employees --</option>
                        @foreach (var emp in Model.Employees)
                        {
                            <option value="@emp.Value">@emp.Text</option>
                        }
                    </select>
                </div>

                <div class="mb-1">
                    <label for="filterStatus" class="small-label">Select by Status:</label>
                    @Html.DropDownListFor(m => m.SelectedStatus,
                        new SelectList(Model.Statuses, "Value", "Text"),
                        "-- All Statuses --",
                        new { id = "filterStatus", @class = "form-control", onchange = "filterTable()" })
                </div>
            </div>

            <!-- Status Panel -->
            <div class="flex-child-element panel-filter">
                <p class="fw-bold mb-2">Review Status</p>
                <p class="mb-1">Total cases: <strong>@Model.ReviewItems.Count</strong></p>
                <p class="mb-1">Pending cases: <strong>@Model.ReviewItems.Count(c => c.StatusCode == "Pending")</strong></p>
                <p class="mb-1">Approved cases: <strong>@Model.ReviewItems.Count(c => c.StatusCode == "Approved")</strong></p>
                <p class="mb-1">Disabled cases: <strong>@Model.ReviewItems.Count(c => c.StatusCode == "Disabled")</strong></p>

                @if (Model.ReviewItems.Count(c => c.StatusCode == "Pending") == 0)
                {
                    <p class="status-resolved mt-3">All cases have been resolved!</p>
                }
                else
                {
                    <p class="status-pending mt-3">Please review all cases!</p>
                }
            </div>

            <!-- Actions Panel -->
            <div class="flex-child-element panel-actions">
                @if (Model.CanSubmitDecision)
                {
                    <p class="fw-bold mb-3">Multiple Update of Selection</p>

                    <div class="d-flex flex-column gap-2 mb-3">
                        <button id="btnApprove" type="button" class="btn btn-success" title="Approve the selected records with status Pending" onclick="approveSelected()">Approve Selection</button>
                        <button id="btnDisable" type="button" class="btn btn-danger" title="Disable the selected records with status Pending" onclick="disableSelected()">Disable Selection</button>
                        <button id="btnPending" type="button" class="btn btn-primary" title="Return the selected records to status Pending" onclick="pendingSelected()">Reset to Pending</button>
                    </div>
                }
                else
                {
                    <p class="fw-bold mb-3">View Mode</p>
                    <p class="text-muted small mb-3">You have read-only access to this review data.</p>
                }

                <div class="d-flex align-items-center mb-2">
                    <img src="~/images/userManual.png" class="manual-icon" alt="User Manual" />
                    <a href="~/files/qad user review web.pdf" title="Download" download>User Manual</a>
                </div>

                <p class="mb-0"><strong>Active Period: @Model.ActivePeriodName</strong></p>
            </div>

        </div>

        <!-- Review Table -->
        <div class="review-table-section">
            <div class="review-table-header">
                <h5 class="review-table-title">Review Table</h5>
                @if (Model.CanSubmitDecision)
                {
                    <input type="submit" value="Save Changes" class="btn btn-warning btn-sm Loader" title="Save your work"
                           id="btnSave" />
                }
            </div>
            <div class="working-list-scroll">
                <table id="WorkingList" class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:18%">Employee</th>
                            <th style="width:10%">Plant</th>
                            <th style="width:8%">System</th>
                            <th style="width:18%">Role</th>
                            <th style="width:12%">Status</th>
                            <th style="width:24%">Comment</th>
                            <th style="width:10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ReviewItems.Count != 0)
                        {
                            @for (int i = 0; i < Model.ReviewItems.Count; i++)
                            {
                                <tr class="@Model.ReviewItems[i].Plant @Model.ReviewItems[i].AD_Username @Model.ReviewItems[i].StatusCode">
                                    <td style="width:18%" title="@Model.ReviewItems[i].AD_Username">
                                        @Html.DisplayFor(m => m.ReviewItems[i].EmployeeName)
                                    </td>
                                    <td style="width:10%">
                                        @Html.DisplayFor(m => m.ReviewItems[i].Plant)
                                    </td>
                                    <td style="width:8%">
                                        @Html.DisplayFor(m => m.ReviewItems[i].SourceSystem)
                                    </td>
                                    <td style="width:18%" title="@Model.ReviewItems[i].RoleDescription">
                                        @Html.DisplayFor(m => m.ReviewItems[i].RoleCode)
                                    </td>
                                    <td class="decision-cell" style="width:12%">
                                        @if (Model.CanSubmitDecision)
                                        {
                                            @Html.DropDownListFor(m => m.ReviewItems[i].StatusCode, new List<SelectListItem>
                                            {
                                                new SelectListItem { Text = "Pending", Value = "Pending" },
                                                new SelectListItem { Text = "Approved", Value = "Approved" },
                                                new SelectListItem { Text = "Disabled", Value = "Disabled" }
                                            })
                                        }
                                        else
                                        {
                                            <span class="badge-status badge-@Model.ReviewItems[i].StatusCode.ToLower()">@Model.ReviewItems[i].StatusCode</span>
                                            @Html.HiddenFor(m => m.ReviewItems[i].StatusCode)
                                        }
                                    </td>
                                    <td style="width:24%">
                                        @if (Model.CanSubmitDecision)
                                        {
                                            @Html.TextBoxFor(m => m.ReviewItems[i].ReviewerComment)
                                        }
                                        else
                                        {
                                            <span class="text-muted">@(Model.ReviewItems[i].ReviewerComment ?? "â€”")</span>
                                            @Html.HiddenFor(m => m.ReviewItems[i].ReviewerComment)
                                        }
                                    </td>
                                    <td style="width:10%">
                                        <a title="Show the menus of the role"
                                           onclick="showMenuDetails('@Url.Action("MenuDetails", "ReviewList", new { roleKey = Model.ReviewItems[i].RoleKey }, Context.Request.Scheme)', 'Menu Details')"
                                           class="btn btn-secondary btn-sm w-100">Details</a>
                                    </td>
                                    <td>
                                        @Html.HiddenFor(m => m.ReviewItems[i].ReviewKey)
                                        @Html.HiddenFor(m => m.ReviewItems[i].RoleKey)
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-4">No Records Found!</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>
